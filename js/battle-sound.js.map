{"version":3,"sources":["../src/battle-sound.ts"],"names":["BattleBGM","url","loopstart","loopend","timer","undefined","isPlaying","isActuallyPlaying","willRewind","play","resume","actuallyResume","pause","actuallyPause","update","stop","destroy","BattleSound","deleteBgm","currentBgm","sound","getSound","currentTime","volume","bgmVolume","updateTime","clearTimeout","progress","setTimeout","Math","max","current","bgm","soundCache","effectVolume","muted","window","HTMLAudioElement","document","createElement","src","Config","routes","client","playEffect","playSound","effect","loadBgm","replaceBGM","push","soundIndex","indexOf","splice","setMute","loudnessPercentToAmplitudePercent","loudnessPercent","decibels","log","pow","setBgmVolume","setEffectVolume","PS","prefs","subscribeAndRun","key","effectvolume","musicvolume","mute"],"mappings":"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","sourcesContent":["\r\nclass BattleBGM {\r\n\t/**\r\n\t * May be shared with other BGM objects: every battle has its own BattleBGM\r\n\t * object, but two battles with the same music will have the same HTMLAudioElement\r\n\t * object.\r\n\t */\r\n\tsound?: HTMLAudioElement;\r\n\turl: string;\r\n\ttimer: number | undefined = undefined;\r\n\tloopstart: number;\r\n\tloopend: number;\r\n\t/**\r\n\t * When multiple battles with BGM are open, they will be `isPlaying`, but only the\r\n\t * first one will be `isActuallyPlaying`. In addition, muting volume or setting\r\n\t * BGM volume to 0 will set `isActuallyPlaying` to false.\r\n\t */\r\n\tisPlaying = false;\r\n\tisActuallyPlaying = false;\r\n\t/**\r\n\t * The sound should be rewound when it next plays.\r\n\t */\r\n\twillRewind = true;\r\n\tconstructor(url: string, loopstart: number, loopend: number) {\r\n\t\tthis.url = url;\r\n\t\tthis.loopstart = loopstart;\r\n\t\tthis.loopend = loopend;\r\n\t}\r\n\tplay() {\r\n\t\tthis.willRewind = true;\r\n\t\tthis.resume();\r\n\t}\r\n\tresume() {\r\n\t\tthis.isPlaying = true;\r\n\t\tthis.actuallyResume();\r\n\t}\r\n\tpause() {\r\n\t\tthis.isPlaying = false;\r\n\t\tthis.actuallyPause();\r\n\t\tBattleBGM.update();\r\n\t}\r\n\tstop() {\r\n\t\tthis.pause();\r\n\t\tthis.willRewind = true;\r\n\t}\r\n\tdestroy() {\r\n\t\tBattleSound.deleteBgm(this);\r\n\t\tthis.pause();\r\n\t}\r\n\r\n\tactuallyResume() {\r\n\t\tif (this !== BattleSound.currentBgm()) return;\r\n\t\tif (this.isActuallyPlaying) return;\r\n\r\n\t\tif (!this.sound) this.sound = BattleSound.getSound(this.url);\r\n\t\tif (!this.sound) return;\r\n\t\tif (this.willRewind) this.sound.currentTime = 0;\r\n\t\tthis.willRewind = false;\r\n\t\tthis.isActuallyPlaying = true;\r\n\t\tthis.sound.volume = BattleSound.bgmVolume / 100;\r\n\t\tthis.sound.play();\r\n\t\tthis.updateTime();\r\n\t}\r\n\tactuallyPause() {\r\n\t\tif (!this.isActuallyPlaying) return;\r\n\t\tthis.isActuallyPlaying = false;\r\n\t\tthis.sound!.pause();\r\n\t\tthis.updateTime();\r\n\t}\r\n\t/**\r\n\t * Handles the hard part of looping the sound\r\n\t */\r\n\tupdateTime() {\r\n\t\tclearTimeout(this.timer);\r\n\t\tthis.timer = undefined;\r\n\t\tif (this !== BattleSound.currentBgm()) return;\r\n\t\tif (!this.sound) return;\r\n\r\n\t\tconst progress = this.sound.currentTime * 1000;\r\n\t\tif (progress > this.loopend - 1000) {\r\n\t\t\tthis.sound.currentTime -= (this.loopend - this.loopstart) / 1000;\r\n\t\t}\r\n\r\n\t\tthis.timer = setTimeout(() => {\r\n\t\t\tthis.updateTime();\r\n\t\t}, Math.max(this.loopend - progress, 1));\r\n\t}\r\n\r\n\tstatic update() {\r\n\t\tconst current = BattleSound.currentBgm();\r\n\t\tfor (const bgm of BattleSound.bgm) {\r\n\t\t\tif (bgm.isPlaying) {\r\n\t\t\t\tif (bgm === current) {\r\n\t\t\t\t\tbgm.actuallyResume();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tbgm.actuallyPause();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nconst BattleSound = new class {\r\n\tsoundCache: {[url: string]: HTMLAudioElement | undefined} = {};\r\n\r\n\tbgm: BattleBGM[] = [];\r\n\r\n\t// options\r\n\teffectVolume = 50;\r\n\tbgmVolume = 50;\r\n\tmuted = false;\r\n\r\n\tgetSound(url: string) {\r\n\t\tif (!window.HTMLAudioElement) return;\r\n\t\tif (this.soundCache[url]) return this.soundCache[url];\r\n\t\ttry {\r\n\t\t\tconst sound = document.createElement('audio');\r\n\t\t\tsound.src = 'https://' + Config.routes.client + '/' + url;\r\n\t\t\tsound.volume = this.effectVolume / 100;\r\n\t\t\tthis.soundCache[url] = sound;\r\n\t\t\treturn sound;\r\n\t\t} catch {}\r\n\t}\r\n\r\n\tplayEffect(url: string) {\r\n\t\tthis.playSound(url, this.muted ? 0 : this.effectVolume);\r\n\t}\r\n\r\n\tplaySound(url: string, volume: number) {\r\n\t\tif (!volume) return;\r\n\t\tconst effect = this.getSound(url);\r\n\t\tif (effect) {\r\n\t\t\teffect.volume = volume / 100;\r\n\t\t\teffect.play();\r\n\t\t}\r\n\t}\r\n\r\n\t/** loopstart and loopend are in milliseconds */\r\n\tloadBgm(url: string, loopstart: number, loopend: number, replaceBGM?: BattleBGM | null) {\r\n\t\tif (replaceBGM) this.deleteBgm(replaceBGM);\r\n\r\n\t\tconst bgm = new BattleBGM(url, loopstart, loopend);\r\n\t\tthis.bgm.push(bgm);\r\n\t\treturn bgm;\r\n\t}\r\n\tdeleteBgm(bgm: BattleBGM) {\r\n\t\tconst soundIndex = BattleSound.bgm.indexOf(bgm);\r\n\t\tif (soundIndex >= 0) BattleSound.bgm.splice(soundIndex, 1);\r\n\t}\r\n\r\n\tcurrentBgm() {\r\n\t\tif (!this.bgmVolume || this.muted) return false;\r\n\t\tfor (const bgm of this.bgm) {\r\n\t\t\tif (bgm.isPlaying) return bgm;\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n\r\n\t// setting\r\n\tsetMute(muted: boolean) {\r\n\t\tmuted = !!muted;\r\n\t\tif (this.muted === muted) return;\r\n\t\tthis.muted = muted;\r\n\t\tBattleBGM.update();\r\n\t}\r\n\r\n\tloudnessPercentToAmplitudePercent(loudnessPercent: number) {\r\n\t\t// 10 dB is perceived as approximately twice as loud\r\n\t\tlet decibels = 10 * Math.log(loudnessPercent / 100) / Math.log(2);\r\n\t\treturn Math.pow(10, decibels / 20) * 100;\r\n\t}\r\n\tsetBgmVolume(bgmVolume: number) {\r\n\t\tthis.bgmVolume = this.loudnessPercentToAmplitudePercent(bgmVolume);\r\n\t\tBattleBGM.update();\r\n\t}\r\n\tsetEffectVolume(effectVolume: number) {\r\n\t\tthis.effectVolume = this.loudnessPercentToAmplitudePercent(effectVolume);\r\n\t}\r\n};\r\n\r\nif (typeof PS === 'object') {\r\n\tPS.prefs.subscribeAndRun(key => {\r\n\t\tif (!key || key === 'musicvolume' || key === 'effectvolume' || key === 'mute') {\r\n\t\t\tBattleSound.effectVolume = PS.prefs.effectvolume;\r\n\t\t\tBattleSound.bgmVolume = PS.prefs.musicvolume;\r\n\t\t\tBattleSound.muted = PS.prefs.mute;\r\n\t\t\tBattleBGM.update();\r\n\t\t}\r\n\t});\r\n}\r\n"],"file":"battle-sound.js"}