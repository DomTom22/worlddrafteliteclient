{"version":3,"sources":["../src/panels.tsx"],"names":["PSRouter","roomid","panelState","currentRoomid","location","pathname","slice","test","subscribeHistory","endsWith","subscribeHash","hash","PS","join","subscribeAndRun","room","id","window","addEventListener","e","possibleRoomid","history","leftRoomWidth","leftRoom","rightRoom","pushState","title","replaceState","state","split","leftRoomid","rightRoomid","router","PSRoomPanel","subscriptions","componentDidMount","props","focus","onParentEvent","push","subscribe","args","forceUpdate","receiveLine","base","setDimensions","offsetWidth","offsetHeight","componentDidUpdate","includes","componentWillUnmount","subscription","unsubscribe","chooseParentValue","value","dropdownButton","parentElem","changeEvent","Event","dispatchEvent","closePopup","render","preact","Component","PSPanelWrapper","children","style","PSMain","getPopupStyle","width","posStyle","scrollable","elem","target","className","preventDefault","stopImmediatePropagation","clickedRoom","name","getAttribute","userid","toID","addRoom","parentRoomid","containingRoomid","rightPopup","username","update","tagName","roomidFromLink","handleButtonClick","startsWith","rooms","parentElement","popups","length","isTextInput","type","modifierKey","ctrlKey","altKey","metaKey","shiftKey","keyCode","arrowKeysUsed","focusLeftRoom","focusRightRoom","prefs","key","document","body","dark","getRoom","curElem","leave","mainmenu","send","href","server","host","Config","routes","client","redirects","isEmptyClick","selection","getSelection","err","BattleTooltips","hideTooltip","pos","activePanel","top","right","left","display","height","bottom","RangeError","position","visibility","margin","offset","getBoundingClientRect","sourceWidth","sourceHeight","availableHeight","documentElement","clientHeight","Math","max","offsetLeft","clientWidth","availableWidth","maxWidth","renderRoom","roomType","roomTypes","Panel","renderPopup","map"],"mappings":"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","sourcesContent":["/**\r\n * Panels\r\n *\r\n * Main view - sets up the frame, and the generic panels.\r\n *\r\n * Also sets up global event listeners.\r\n *\r\n * @author Guangcong Luo <guangcongluo@gmail.com>\r\n * @license AGPLv3\r\n */\r\n\r\nclass PSRouter {\r\n\troomid = '' as RoomID;\r\n\tpanelState = '';\r\n\tconstructor() {\r\n\t\tconst currentRoomid = location.pathname.slice(1);\r\n\t\tif (/^[a-z0-9-]+$/.test(currentRoomid)) {\r\n\t\t\tthis.subscribeHistory();\r\n\t\t} else if (location.pathname.endsWith('.html')) {\r\n\t\t\tthis.subscribeHash();\r\n\t\t}\r\n\t}\r\n\tsubscribeHash() {\r\n\t\tif (location.hash) {\r\n\t\t\tconst currentRoomid = location.hash.slice(1);\r\n\t\t\tif (/^[a-z0-9-]+$/.test(currentRoomid)) {\r\n\t\t\t\tPS.join(currentRoomid as RoomID);\r\n\t\t\t} else {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t}\r\n\t\tPS.subscribeAndRun(() => {\r\n\t\t\tconst roomid = PS.room.id;\r\n\t\t\tlocation.hash = roomid ? '#' + roomid : '';\r\n\t\t});\r\n\t\twindow.addEventListener('hashchange', e => {\r\n\t\t\tconst possibleRoomid = location.hash.slice(1);\r\n\t\t\tlet currentRoomid: RoomID | null = null;\r\n\t\t\tif (/^[a-z0-9-]*$/.test(possibleRoomid)) {\r\n\t\t\t\tcurrentRoomid = possibleRoomid as RoomID;\r\n\t\t\t}\r\n\t\t\tif (currentRoomid !== null) {\r\n\t\t\t\tPS.join(currentRoomid);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\tsubscribeHistory() {\r\n\t\tconst currentRoomid = location.pathname.slice(1);\r\n\t\tif (/^[a-z0-9-]+$/.test(currentRoomid)) {\r\n\t\t\tPS.join(currentRoomid as RoomID);\r\n\t\t} else {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (!window.history) return;\r\n\t\tPS.subscribeAndRun(() => {\r\n\t\t\tconst room = PS.room;\r\n\t\t\tconst roomid = room.id;\r\n\t\t\tconst panelState = (PS.leftRoomWidth ?\r\n\t\t\t\tPS.leftRoom.id + '..' + PS.rightRoom!.id :\r\n\t\t\t\troomid);\r\n\t\t\tif (roomid === this.roomid && panelState === this.panelState) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif (panelState === this.panelState) {\r\n\t\t\t\thistory.pushState(panelState, room.title, '/' + roomid);\r\n\t\t\t} else {\r\n\t\t\t\thistory.replaceState(panelState, room.title, '/' + roomid);\r\n\t\t\t}\r\n\t\t\tthis.roomid = roomid;\r\n\t\t\tthis.panelState = panelState;\r\n\t\t});\r\n\t\twindow.addEventListener('popstate', e => {\r\n\t\t\tconst possibleRoomid = location.pathname.slice(1);\r\n\t\t\tlet roomid: RoomID | null = null;\r\n\t\t\tif (/^[a-z0-9-]*$/.test(possibleRoomid)) {\r\n\t\t\t\troomid = possibleRoomid as RoomID;\r\n\t\t\t}\r\n\t\t\tif (typeof e.state === 'string') {\r\n\t\t\t\tconst [leftRoomid, rightRoomid] = e.state.split('..') as RoomID[];\r\n\t\t\t\tPS.join(leftRoomid, 'left');\r\n\t\t\t\tif (rightRoomid) {\r\n\t\t\t\t\tPS.join(rightRoomid, 'right');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (roomid !== null) {\r\n\t\t\t\tPS.join(roomid);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\nPS.router = new PSRouter();\r\n\r\nclass PSRoomPanel<T extends PSRoom = PSRoom> extends preact.Component<{room: T}> {\r\n\tsubscriptions: PSSubscription[] = [];\r\n\tcomponentDidMount() {\r\n\t\tif (PS.room === this.props.room) this.focus();\r\n\t\tthis.props.room.onParentEvent = (id: string, e?: Event) => {\r\n\t\t\tif (id === 'focus') this.focus();\r\n\t\t};\r\n\t\tthis.subscriptions.push(this.props.room.subscribe(args => {\r\n\t\t\tif (!args) this.forceUpdate();\r\n\t\t\telse this.receiveLine(args);\r\n\t\t}));\r\n\t\tif (this.base) {\r\n\t\t\tthis.props.room.setDimensions(this.base.offsetWidth, this.base.offsetHeight);\r\n\t\t}\r\n\t}\r\n\tcomponentDidUpdate() {\r\n\t\tif (this.base && ['popup', 'semimodal-popup'].includes(this.props.room.location)) {\r\n\t\t\tthis.props.room.setDimensions(this.base.offsetWidth, this.base.offsetHeight);\r\n\t\t}\r\n\t}\r\n\tcomponentWillUnmount() {\r\n\t\tthis.props.room.onParentEvent = null;\r\n\t\tfor (const subscription of this.subscriptions) {\r\n\t\t\tsubscription.unsubscribe();\r\n\t\t}\r\n\t\tthis.subscriptions = [];\r\n\t}\r\n\treceiveLine(args: Args) {}\r\n\t/**\r\n\t * PS has \"fake select menus\", buttons that act like <select> dropdowns.\r\n\t * This function is used by the popups they open to change the button\r\n\t * values.\r\n\t */\r\n\tchooseParentValue(value: string) {\r\n\t\tconst dropdownButton = this.props.room.parentElem as HTMLButtonElement;\r\n\t\tdropdownButton.value = value;\r\n\t\tconst changeEvent = new Event('change');\r\n\t\tdropdownButton.dispatchEvent(changeEvent);\r\n\t\tPS.closePopup();\r\n\t}\r\n\tfocus() {}\r\n\trender() {\r\n\t\treturn <PSPanelWrapper room={this.props.room}>\r\n\t\t\t<div class=\"mainmessage\"><p>Loading...</p></div>\r\n\t\t</PSPanelWrapper>;\r\n\t}\r\n}\r\n\r\nfunction PSPanelWrapper(props: {\r\n\troom: PSRoom, children: preact.ComponentChildren, scrollable?: boolean, width?: number | 'auto',\r\n}) {\r\n\tconst room = props.room;\r\n\tif (room.location === 'mini-window') {\r\n\t\tif (room.id === 'news') {\r\n\t\t\treturn <div>{props.children}</div>;\r\n\t\t}\r\n\t\treturn <div id={`room-${room.id}`} class=\"mini-window-contents ps-room-light\">{props.children}</div>;\r\n\t}\r\n\tif (room.location !== 'left' && room.location !== 'right') {\r\n\t\tconst style = PSMain.getPopupStyle(room, props.width);\r\n\t\treturn <div class=\"ps-popup\" id={`room-${room.id}`} style={style}>\r\n\t\t\t{props.children}\r\n\t\t</div>;\r\n\t}\r\n\tconst style = PSMain.posStyle(room);\r\n\treturn <div\r\n\t\tclass={'ps-room' + (room.id === '' ? '' : ' ps-room-light') + (props.scrollable ? ' scrollable' : '')}\r\n\t\tid={`room-${room.id}`}\r\n\t\tstyle={style}\r\n\t>\r\n\t\t{props.children}\r\n\t</div>;\r\n}\r\n\r\nclass PSMain extends preact.Component {\r\n\tconstructor() {\r\n\t\tsuper();\r\n\t\tPS.subscribe(() => this.forceUpdate());\r\n\r\n\t\twindow.addEventListener('click', e => {\r\n\t\t\tlet elem = e.target as HTMLElement | null;\r\n\t\t\tif (elem?.className === 'ps-overlay') {\r\n\t\t\t\tPS.closePopup();\r\n\t\t\t\te.preventDefault();\r\n\t\t\t\te.stopImmediatePropagation();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tlet clickedRoom = null;\r\n\t\t\twhile (elem) {\r\n\t\t\t\tif (` ${elem.className} `.includes(' username ')) {\r\n\t\t\t\t\tconst name = elem.getAttribute('data-name');\r\n\t\t\t\t\tconst userid = toID(name);\r\n\t\t\t\t\tconst roomid = `user-${userid}` as RoomID;\r\n\t\t\t\t\tPS.addRoom({\r\n\t\t\t\t\t\tid: roomid,\r\n\t\t\t\t\t\tparentElem: elem,\r\n\t\t\t\t\t\tparentRoomid: PSMain.containingRoomid(elem),\r\n\t\t\t\t\t\trightPopup: elem.className === 'userbutton username',\r\n\t\t\t\t\t\tusername: name,\r\n\t\t\t\t\t});\r\n\t\t\t\t\tPS.update();\r\n\t\t\t\t\te.preventDefault();\r\n\t\t\t\t\te.stopImmediatePropagation();\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tif (elem.tagName === 'A' || elem.getAttribute('data-href')) {\r\n\t\t\t\t\tconst roomid = this.roomidFromLink(elem as HTMLAnchorElement);\r\n\t\t\t\t\tif (roomid !== null) {\r\n\t\t\t\t\t\tPS.addRoom({\r\n\t\t\t\t\t\t\tid: roomid,\r\n\t\t\t\t\t\t\tparentElem: elem,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tPS.update();\r\n\t\t\t\t\t\te.preventDefault();\r\n\t\t\t\t\t\te.stopImmediatePropagation();\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tif (elem.tagName === 'BUTTON') {\r\n\t\t\t\t\tif (this.handleButtonClick(elem as HTMLButtonElement)) {\r\n\t\t\t\t\t\te.preventDefault();\r\n\t\t\t\t\t\te.stopImmediatePropagation();\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tif (elem.id.startsWith('room-')) {\r\n\t\t\t\t\tclickedRoom = PS.rooms[elem.id.slice(5)];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\telem = elem.parentElement;\r\n\t\t\t}\r\n\t\t\tif (PS.room !== clickedRoom) {\r\n\t\t\t\tif (clickedRoom) PS.room = clickedRoom;\r\n\t\t\t\twhile (PS.popups.length && (!clickedRoom || clickedRoom.id !== PS.popups[PS.popups.length - 1])) {\r\n\t\t\t\t\tPS.closePopup();\r\n\t\t\t\t}\r\n\t\t\t\tPS.update();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\twindow.addEventListener('keydown', e => {\r\n\t\t\tlet elem = e.target as HTMLInputElement | null;\r\n\t\t\tif (elem) {\r\n\t\t\t\tlet isTextInput = (elem.tagName === 'INPUT' || elem.tagName === 'TEXTAREA');\r\n\t\t\t\tif (isTextInput && ['button', 'radio', 'checkbox', 'file'].includes(elem.type)) {\r\n\t\t\t\t\tisTextInput = false;\r\n\t\t\t\t}\r\n\t\t\t\tif (isTextInput && elem.value) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (PS.room.onParentEvent) {\r\n\t\t\t\tif (PS.room.onParentEvent('keydown', e) === false) {\r\n\t\t\t\t\te.stopImmediatePropagation();\r\n\t\t\t\t\te.preventDefault();\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tlet modifierKey = e.ctrlKey || e.altKey || e.metaKey || e.shiftKey;\r\n\t\t\tif (modifierKey) return;\r\n\t\t\tif (e.keyCode === 37) { // left\r\n\t\t\t\tPS.arrowKeysUsed = true;\r\n\t\t\t\tPS.focusLeftRoom();\r\n\t\t\t} else if (e.keyCode === 39) { // right\r\n\t\t\t\tPS.arrowKeysUsed = true;\r\n\t\t\t\tPS.focusRightRoom();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tPS.prefs.subscribeAndRun(key => {\r\n\t\t\tif (!key || key === 'dark') {\r\n\t\t\t\tdocument.body.className = PS.prefs.dark ? 'dark' : '';\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\tgetRoom(elem: HTMLElement) {\r\n\t\tlet curElem: HTMLElement | null = elem;\r\n\t\twhile (curElem) {\r\n\t\t\tif (curElem.id.startsWith('room-')) {\r\n\t\t\t\treturn PS.rooms[curElem.id.slice(5)];\r\n\t\t\t}\r\n\t\t\tcurElem = curElem.parentElement;\r\n\t\t}\r\n\t}\r\n\thandleButtonClick(elem: HTMLButtonElement) {\r\n\t\tswitch (elem.name) {\r\n\t\tcase 'closeRoom':\r\n\t\t\tPS.leave(elem.value as RoomID);\r\n\t\t\treturn true;\r\n\t\tcase 'joinRoom':\r\n\t\t\tPS.addRoom({\r\n\t\t\t\tid: elem.value as RoomID,\r\n\t\t\t\tparentElem: elem,\r\n\t\t\t});\r\n\t\t\tPS.update();\r\n\t\t\treturn true;\r\n\t\tcase 'send':\r\n\t\tcase 'cmd':\r\n\t\t\tconst room = this.getRoom(elem) || PS.mainmenu;\r\n\t\t\troom.send(elem.value, elem.name === 'send');\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\troomidFromLink(elem: HTMLAnchorElement) {\r\n\t\tlet href = elem.getAttribute('data-href');\r\n\t\tif (href) {\r\n\t\t\t// yes that's what we needed\r\n\t\t} else if (PS.server.id === 'showdown') {\r\n\t\t\tif (elem.host && elem.host !== Config.routes.client && elem.host !== 'psim.us') {\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t\thref = elem.pathname;\r\n\t\t} else {\r\n\t\t\tif (elem.host !== location.host) {\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t\thref = elem.pathname;\r\n\t\t}\r\n\t\tconst roomid = href.slice(1);\r\n\t\tif (!/^[a-z0-9-]*$/.test(roomid)) {\r\n\t\t\treturn null; // not a roomid\r\n\t\t}\r\n\t\tconst redirects = /^(appeals?|rooms?suggestions?|suggestions?|adminrequests?|bugs?|bugreports?|rules?|faq|credits?|news|privacy|contact|dex|insecure)$/;\r\n\t\tif (redirects.test(roomid)) return null;\r\n\t\treturn roomid as RoomID;\r\n\t}\r\n\tstatic containingRoomid(elem: HTMLElement) {\r\n\t\tlet curElem: HTMLElement | null = elem;\r\n\t\twhile (curElem) {\r\n\t\t\tif (curElem.id.startsWith('room-')) {\r\n\t\t\t\treturn curElem.id.slice(5) as RoomID;\r\n\t\t\t}\r\n\t\t\tcurElem = curElem.parentElement;\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n\tstatic isEmptyClick(e: MouseEvent) {\r\n\t\ttry {\r\n\t\t\tconst selection = window.getSelection()!;\r\n\t\t\tif (selection.type === 'Range') return false;\r\n\t\t} catch (err) {}\r\n\t\tBattleTooltips.hideTooltip();\r\n\t}\r\n\tstatic posStyle(room: PSRoom) {\r\n\t\tlet pos: PanelPosition | null = null;\r\n\t\tif (PS.leftRoomWidth === 0) {\r\n\t\t\t// one panel visible\r\n\t\t\tif (room === PS.activePanel) pos = {top: 56};\r\n\t\t} else {\r\n\t\t\t// both panels visible\r\n\t\t\tif (room === PS.leftRoom) pos = {top: 56, right: PS.leftRoomWidth};\r\n\t\t\tif (room === PS.rightRoom) pos = {top: 56, left: PS.leftRoomWidth};\r\n\t\t}\r\n\r\n\t\tif (!pos) return {display: 'none'};\r\n\r\n\t\tlet top: number | null = (pos.top || 0);\r\n\t\tlet height: number | null = null;\r\n\t\tlet bottom: number | null = (pos.bottom || 0);\r\n\t\tif (bottom > 0 || top < 0) {\r\n\t\t\theight = bottom - top;\r\n\t\t\tif (height < 0) throw new RangeError(\"Invalid pos range\");\r\n\t\t\tif (top < 0) top = null;\r\n\t\t\telse bottom = null;\r\n\t\t}\r\n\r\n\t\tlet left: number | null = (pos.left || 0);\r\n\t\tlet width: number | null = null;\r\n\t\tlet right: number | null = (pos.right || 0);\r\n\t\tif (right > 0 || left < 0) {\r\n\t\t\twidth = right - left - 1;\r\n\t\t\tif (width < 0) throw new RangeError(\"Invalid pos range\");\r\n\t\t\tif (left < 0) left = null;\r\n\t\t\telse right = null;\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\tdisplay: 'block',\r\n\t\t\ttop: top === null ? `auto` : `${top}px`,\r\n\t\t\theight: height === null ? `auto` : `${height}px`,\r\n\t\t\tbottom: bottom === null ? `auto` : `${-bottom}px`,\r\n\t\t\tleft: left === null ? `auto` : `${left}px`,\r\n\t\t\twidth: width === null ? `auto` : `${width}px`,\r\n\t\t\tright: right === null ? `auto` : `${-right}px`,\r\n\t\t};\r\n\t}\r\n\tstatic getPopupStyle(room: PSRoom, width?: number | 'auto'): any {\r\n\t\tif (room.location === 'modal-popup' || !room.parentElem) {\r\n\t\t\treturn {width: width || 480};\r\n\t\t}\r\n\t\tif (!room.width || !room.height) {\r\n\t\t\treturn {\r\n\t\t\t\tposition: 'absolute',\r\n\t\t\t\tvisibility: 'hidden',\r\n\t\t\t\tmargin: 0,\r\n\t\t\t\ttop: 0,\r\n\t\t\t\tleft: 0,\r\n\t\t\t};\r\n\t\t}\r\n\t\t// nonmodal popup: should be positioned near source element\r\n\t\tlet style: any = {\r\n\t\t\tposition: 'absolute',\r\n\t\t\tmargin: 0,\r\n\t\t};\r\n\t\tlet offset = room.parentElem.getBoundingClientRect();\r\n\t\tlet sourceWidth = offset.width;\r\n\t\tlet sourceHeight = offset.height;\r\n\r\n\t\tlet availableHeight = document.documentElement.clientHeight;\r\n\t\tlet height = room.height;\r\n\t\twidth = width || room.width;\r\n\r\n\t\tif (room.rightPopup) {\r\n\r\n\t\t\tif (availableHeight > offset.top + height + 5 &&\r\n\t\t\t\t(offset.top < availableHeight * 2 / 3 || offset.top + 200 < availableHeight)) {\r\n\t\t\t\tstyle.top = offset.top;\r\n\t\t\t} else if (offset.top + sourceHeight >= height) {\r\n\t\t\t\tstyle.bottom = Math.max(availableHeight - offset.top - sourceHeight, 0);\r\n\t\t\t} else {\r\n\t\t\t\tstyle.top = Math.max(0, availableHeight - height);\r\n\t\t\t}\r\n\t\t\tlet offsetLeft = offset.left + sourceWidth;\r\n\t\t\tif (width !== 'auto' && offsetLeft + width > document.documentElement.clientWidth) {\r\n\t\t\t\tstyle.right = 1;\r\n\t\t\t} else {\r\n\t\t\t\tstyle.left = offsetLeft;\r\n\t\t\t}\r\n\r\n\t\t} else {\r\n\r\n\t\t\tif (availableHeight > offset.top + sourceHeight + height + 5 &&\r\n\t\t\t\t(offset.top + sourceHeight < availableHeight * 2 / 3 || offset.top + sourceHeight + 200 < availableHeight)) {\r\n\t\t\t\tstyle.top = offset.top + sourceHeight;\r\n\t\t\t} else if (height + 5 <= offset.top) {\r\n\t\t\t\tstyle.bottom = Math.max(availableHeight - offset.top, 0);\r\n\t\t\t} else if (height + 10 < availableHeight) {\r\n\t\t\t\tstyle.bottom = 5;\r\n\t\t\t} else {\r\n\t\t\t\tstyle.top = 0;\r\n\t\t\t}\r\n\r\n\t\t\tlet availableWidth = document.documentElement.clientWidth - offset.left;\r\n\t\t\tif (width !== 'auto' && availableWidth < width + 10) {\r\n\t\t\t\tstyle.right = 10;\r\n\t\t\t} else {\r\n\t\t\t\tstyle.left = offset.left;\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\tif (width) style.maxWidth = width;\r\n\r\n\t\treturn style;\r\n\t}\r\n\trenderRoom(room: PSRoom) {\r\n\t\tconst roomType = PS.roomTypes[room.type];\r\n\t\tconst Panel = roomType ? roomType.Component : PSRoomPanel;\r\n\t\treturn <Panel key={room.id} room={room} />;\r\n\t}\r\n\trenderPopup(room: PSRoom) {\r\n\t\tconst roomType = PS.roomTypes[room.type];\r\n\t\tconst Panel = roomType ? roomType.Component : PSRoomPanel;\r\n\t\tif (room.location === 'popup' && room.parentElem) {\r\n\t\t\treturn <Panel key={room.id} room={room} />;\r\n\t\t}\r\n\t\treturn <div key={room.id} class=\"ps-overlay\">\r\n\t\t\t<Panel room={room} />\r\n\t\t</div>;\r\n\t}\r\n\trender() {\r\n\t\tlet rooms = [] as preact.VNode[];\r\n\t\tfor (const roomid in PS.rooms) {\r\n\t\t\tconst room = PS.rooms[roomid]!;\r\n\t\t\tif (room.location === 'left' || room.location === 'right') {\r\n\t\t\t\trooms.push(this.renderRoom(room));\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn <div class=\"ps-frame\">\r\n\t\t\t<PSHeader style={{top: 0, left: 0, right: 0, height: '50px'}} />\r\n\t\t\t{rooms}\r\n\t\t\t{PS.popups.map(roomid => this.renderPopup(PS.rooms[roomid]!))}\r\n\t\t</div>;\r\n\t}\r\n}\r\n\r\ntype PanelPosition = {top?: number, bottom?: number, left?: number, right?: number} | null;\r\n"],"file":"panels.js"}